const currency = [
    {
        name: "Gems",
        id: "gems",
        img: "spr_resource_gem_0.png",
    },
    {
        name: "Silver token",
        id: "silver_token",
        img: "silver_token.png",
    },
    {
        name: "Gold token",
        id: "gold_token",
        img: "gold_token.png",
    },
    {
        name: "Coins",
        id: "coins",
        img: "spr_gold_0.png",
    },
    {
        name: "BLC",
        id: "blc",
        img: "spr_blc_0.png",
    },
    {
        name: "MLC",
        id: "mlc",
        img: "spr_mlc_0.png",
    },
	{
        name: "ULC",
        id: "ulc",
        img: "",
    },
];
const leaves = [
    {
        name: "Normal",
        id: "leaves",
        img: "spr_leaf_0.png",
    },
    {
        name: "Gold",
        id: "gold",
        img: "spr_leaf_gold_0.png",
    },
    {
        name: "Platinum",
        id: "platinum",
        img: "spr_leaf_platinum_0.png",
    },
    {
        name: "Bismuth",
        id: "bismuth",
        img: "spr_leaf_bismuth_0.png",
    },
    {
        name: "Cosmic",
        id: "cosmic",
        img: "spr_leaf_cosmic_0.png",
    },
    {
        name: "Void",
        id: "void",
        img: "spr_leaf_void_0.png",
    },
    {
        name: "Exotic",
        id: "exotic",
        img: "spr_leaf_exotic_0.png",
    },
    {
        name: "Celestial",
        id: "celestial",
        img: "spr_leaf_celestial_0.png",
    },
    {
        name: "Mythical",
        id: "mythical",
        img: "spr_leaf_mythical_0.png",
    },
    {
        name: "Lava",
        id: "lava",
        img: "spr_leaf_lava_0.png",
    },
    {
        name: "Ice",
        id: "ice",
        img: "spr_leaf_ice_0.png",
    },
    {
        name: "Obsidian",
        id: "obsidian",
        img: "spr_leaf_obsidian_0.png",
    },
    {
        name: "Silicon",
        id: "silicon",
        img: "spr_leaf_silicon_0.png",
    },
    {
        name: "Benitoite",
        id: "benitoite",
        img: "spr_leaf_benitoite_0.png",
    },
    {
        name: "Moonstone",
        id: "moonstone",
        img: "Moonstone_Leaf.png",
    },
    {
        name: "Sand",
        id: "sand",
        img: "Sand_Leaf.png",
    },
    {
        name: "Ancient",
        id: "ancient",
        img: "Ancient_Leaf.png",
    },
    {
        name: "Sacred Leaves",
        id: "sacred",
        img: "Sacred_Leaf.png",
    },
    {
        name: "Biotite Leaves",
        id: "biotite",
        img: "Biotite_Leaf.png",
    },
    {
        name: "Malachite Leaves",
        id: "malachite",
        img: "Malachite_Leaf.png",
    },
    {
        name: "Hematite Leaves",
        id: "hematite",
        img: "Hematite_Leaf.png",
    },
    {
        name: "Electrical Energy",
        id: "energy_electrical",
        img: "Electrical_energy_Leaf.png",
    },
    {
        name: "Plasma Leaves",
        id: "plasma",
        img: "120px-Plasma_Leaf.png",
    },
    {
        name: "Coal Leaves",
        id: "coal",
        img: "Coal_Leaf.png",
    },
	{
        name: "Empty Soul Leaves",
        id: "soul_empty",
        img: "Empty_Soul_Leaf.png",
    },
	{
        name: "Soul Leaves",
        id: "soul",
        img: "Soul_Leaf_32x32.png",
    },
	{
        name: "Quark Leaves",
        id: "quark",
        img: "Quark_Leaf.png",
    },
	{
        name: "Dusk Leaves",
        id: "dusk",
        img: "",
    },
    {},
    {
        name: "Amber",
        id: "amber",
        img: "spr_leaf_amber_0.png",
    },
    {
        name: "Amethyst",
        id: "amethyst",
        img: "spr_leaf_amethyst_0.png",
    },
    {
        name: "Emerald",
        id: "emerald",
        img: "spr_leaf_emerald_0.png",
    },
    {
        name: "Kyanite",
        id: "kyanite",
        img: "spr_leaf_kyanite_0.png",
    },
    {
        name: "Rhodonite",
        id: "rhodonite",
        img: "spr_leaf_rhodonite_0.png",
    },
    {
        name: "Ruby",
        id: "ruby",
        img: "spr_leaf_ruby_0.png",
    },
    {
        name: "Tektite",
        id: "tektite",
        img: "spr_leaf_tektite_0.png",
    },
	{},
    {
        name: "Red Science",
        id: "flask_red",
        img: "spr_flask_red_0.png",
    },
    {
        name: "Green Science",
        id: "flask_green",
        img: "spr_flask_green_0.png",
    },
    {
        name: "Blue Science",
        id: "flask_blue",
        img: "spr_flask_blue_0.png",
    },
    {
        name: "Magenta Science",
        id: "flask_magenta",
        img: "spr_flask_magenta_0.png",
    },
    {
        name: "Orange Science",
        id: "flask_orange",
        img: "spr_flask_orange_0.png",
    },
    {
        name: "Black Science",
        id: "flask_black",
        img: "spr_flask_black_0.png",
    },
    {
        name: "Strange Science",
        id: "flask_strange",
        img: "spr_flask_strange_0.png",
    },
    {},
    {
        name: "Challenge Points",
        id: "cp",
        img: "spr_cp.png",
    },
    {
        name: "Cheese",
        id: "cheese",
        img: "cheese.png",
    },
    {
        name: "Beer",
        id: "beer",
        img: "",
    },
    {
        name: "Mulch",
        id: "mulch",
        img: "",
    },
    {
        name: "Card Parts",
        id: "card_parts",
        img: "",
    },
    {
        name: "Transcension Card Parts",
        id: "transcension_card_parts",
        img: "",
    },
    {
        name: "Shards",
        id: "shards",
        img: "",
    },
    {
        name: "Ascension Shards",
        id: "ascension_shards",
        img: "",
    },
    {
        name: "Fusion Shards",
        id: "fusion_shards",
        img: "",
    },
    {
        name: "Transformation Shards",
        id: "transformation_shards",
        img: "",
    },
];
const dices = [
    {
        name: "Dice",
        id: "dice",
        img: "",
    },
    {
        name: "Power Dice",
        id: "power_dice",
        img: "",
    },
    {
        name: "Azurite Leaves",
        id: "azurite",
        img: "",
    },
    {
        name: "Niobium Leaves",
        id: "niobium",
        img: "",
    },
];
const borbventures = [
    {
        name: "Borbs",
        id: "borbs",
        img: "borb.png",
    },
    {
        name: "Borb Juice",
        id: "borb_juice",
        img: "",
    },
    {
        name: "Borb Ascension Juice",
        id: "borb_ascension_juice",
        img: "",
    },
    {
        name: "Borb Token",
        id: "borb_token",
        img: "",
    },
    {
        name: "Borb Rune",
        id: "borb_rune",
        img: "",
    },
    {
        name: "Borb Ascension Rune",
        id: "borb_ascension_rune",
        img: "",
    },
];
const mines = [
    {
        name: "Coal Diamond",
        id: "diamond_coal",
        img: "",
    },
    {
        name: "Shiny Diamond",
        id: "diamond_shiny",
        img: "",
    },
    {
        name: "Fuel",
        id: "fuel",
        img: "",
    },
    {
        name: "Coal Time Sphere",
        id: "coal_time_sphere",
        img: "",
    },
];
const quarks = [
    {
        name: "Quantum Blob",
        id: "quantum_blob",
        img: "",
    },
    {
        name: "Quark Blob",
        id: "quark_blob",
        img: "",
    },
    {
        name: "Quark Structure",
        id: "quark_structure",
        img: "",
    },
    {
        name: "Leafton",
        id: "leafton",
        img: "",
    },
];
const natures = [
    {
        name: "Nature Gems",
        id: "nature_gems",
        img: "",
    },
	{
        name: "Magic Mulch",
        id: "magic_mulch",
        img: "",
    },
    {
        name: "Nature Time Sphere",
        id: "nature_time_sphere",
        img: "",
    },
    {
        name: "3-Leaf Clover",
        id: "clover_basic3",
        img: "",
    },
    {
        name: "4-Leaf Clover",
        id: "clover_basic4",
        img: "",
    },
	{
        name: "Aster(Plant)",
        id: "plant_aster",
        img: "",
    },
    {
        name: "Camomile(Plant)",
        id: "plant_camomile",
        img: "",
    },
    {
        name: "Cornflower(Plant)",
        id: "plant_cornflower",
        img: "",
    },
    {
        name: "Daffodil(Plant)",
        id: "plant_daffodil",
        img: "",
    },
	{
        name: "Dame(Plant)",
        id: "plant_dame",
        img: "",
    },
    {
        name: "Dandelion(Plant)",
        id: "plant_dandelion",
        img: "",
    },
    {
        name: "Forget-Me-Not(Plant)",
        id: "plant_forgetmenot",
        img: "",
    },
    {
        name: "Hibiscus(Plant)",
        id: "plant_hibiscus",
        img: "",
	},
	{
        name: "Hyacinth(Plant)",
        id: "plant_hyacinth",
        img: "",
    },
    {
        name: "Lily(Plant)",
        id: "plant_lily",
        img: "",
    },
    {
        name: "Marigold(Plant)",
        id: "plant_marigold",
        img: "",
    },
    {
        name: "Pansy(Plant)",
        id: "plant_pansy",
        img: "",
	},
	{
        name: "Poppy(Plant)",
        id: "plant_poppy",
        img: "",
    },
    {
        name: "Primula(Plant)",
        id: "plant_primula",
        img: "",
    },
    {
        name: "Rose(Plant)",
        id: "plant_rose",
        img: "",
    },
    {
        name: "Tulip(Plant)",
        id: "plant_tulip",
        img: "",
    },
	{
        name: "Auroraflit(Butterfly)",
        id: "butterfly_auroraflit",
        img: "",
    },
    {
        name: "Blossomhaze(Butterfly)",
        id: "butterfly_blossomhaze",
        img: "",
    },
    {
        name: "Citrineshine(Butterfly)",
        id: "butterfly_citrineshine",
        img: "",
    },
    {
        name: "Crystalvale(Butterfly)",
        id: "butterfly_crystalvale",
        img: "",
    },
	{
        name: "Duskmoth(Butterfly)",
        id: "butterfly_duskmoth",
        img: "",
    },
    {
        name: "Emberglide(Butterfly)",
        id: "butterfly_emberglide",
        img: "",
    },
    {
        name: "Meadowdance(Butterfly)",
        id: "butterfly_meadowdance",
        img: "",
    },
    {
        name: "Moonbloom(Butterfly)",
        id: "butterfly_moonbloom",
        img: "",
	},
	{
        name: "Oceaniclash(Butterfly)",
        id: "butterfly_oceaniclash",
        img: "",
    },
    {
        name: "Prismwing(Butterfly)",
        id: "butterfly_prismwing",
        img: "",
    },
    {
        name: "Radiantwing(Butterfly)",
        id: "butterfly_radiantwing",
        img: "",
    },
    {
        name: "Serenewisp(Butterfly)",
        id: "butterfly_serenewisp",
        img: "",
	},
	{
        name: "Soulwing(Butterfly)",
        id: "butterfly_soulwing",
        img: "",
    },
    {
        name: "Starlance(Butterfly)",
        id: "butterfly_starlance",
        img: "",
    },
    {
        name: "Sunspark(Butterfly)",
        id: "butterfly_sunspark",
        img: "",
    },
    {
        name: "Twilightglow(Butterfly)",
        id: "butterfly_twilightglow",
        img: "",
    },
];
const souls = [
    {
        name: "Soul Stone",
        id: "soul_stones",
        img: "",
    },
    {
        name: "Soul Key",
        id: "soul_keys",
        img: "",
    },
    {
        name: "Soul Particle",
        id: "soul_particles",
        img: "",
    },
    {
        name: "Soul Entity",
        id: "soul_entities",
        img: "",
    },
	{
        name: "Soul Flask",
        id: "soul_flask",
        img: "",
    },
];
const fishings = [
    {
        name: "Trash",
        id: "fish_trash",
        img: "",
    },
    {
        name: "Fish Credits",
        id: "fish_credits",
        img: "",
    },
];

let currentSave;
let currentProfile;

document.addEventListener("DOMContentLoaded", () => {
    let fileInput = document.getElementById("fileInput");

    fileInput.addEventListener("input", () => {
        let reader = new FileReader();
        reader.addEventListener("load", (e) =>
            fileInput.files[0].type === "application/json"
                ? loadJson(e.target.result)
                : loadDat(e.target.result)
        );
        reader.readAsText(fileInput.files[0]);
    });

    document.getElementById("saveButton").addEventListener("click", save);
    document.getElementById("saveRawButton").addEventListener("click", saveRaw);
});

window.onerror = (error) => {
    alert(`An Unexpected Error Occurred. Please open an issue on github.\n${error}`);
};

/** @param  {...number} items */
function createRow(...items) {
    let row = document.createElement("tr");

    for (const item of items) {
        let td = document.createElement("td");
        if (typeof item == "string" || typeof item == "number") {
            td.innerText = item;
        } else {
            td.appendChild(item);
        }
        row.append(td);
    }

    return row;
}

/** @param {string} data */
function sha1Array(data) {
    let hash = sha1.create();
    hash.update(data);
    return hash.array();
}

/**
 * @param {string} message
 * @param {string} key
 * @returns {string} hash
 */
function SHA1_hmac(message, key) {
    const hashSize = 20;
    const blockSize = 64;

    const keyBuf = new Uint8Array(blockSize);
    const ipad = new Uint8Array(blockSize + message.length);
    const opad = new Uint8Array(blockSize + hashSize);

    if (key.length > blockSize) {
        let hash = sha1Array(key);
        for (let i = 0; i < hash.length; i++) {
            keyBuf[i] = hash[i];
        }
    } else {
        for (let i = 0; i < key.length; i++) {
            keyBuf[i] = key.charCodeAt(i);
        }
    }

    for (let i = 0; i < blockSize; i++) {
        ipad[i] = keyBuf[i] ^ 0x36;
        opad[i] = keyBuf[i] ^ 0x5c;
    }

    for (let i = 0; i < message.length; i++) {
        ipad[i + blockSize] = message.charCodeAt(i);
    }

    let inner = sha1Array(ipad);

    for (let i = 0; i < hashSize; i++) {
        opad[i + blockSize] = inner[i];
    }

    return sha1(opad);
}

function parseDate(t) {
    return new Date(t.year, t.month - 1, t.day, t.hour, t.minute, t.second);
}
function writeDate(t, date) {
    t.year = date.getFullYear();
    t.month = date.getMonth() + 1;
    t.day = date.getDate();

    t.hour = date.getHours();
    t.minute = date.getMinutes();
    t.second = date.getSeconds();
}

function dateString(t) {
    function pad(v, l = 2) {
        return v.toString().padStart(l, "0");
    }
    return `${pad(t.year, 4)}-${pad(t.month)}-${pad(t.day)}T${pad(
        t.hour
    )}:${pad(t.minute)}:${pad(t.second)}`;
}

/** @param {string} str */
function capitalize(str) {
    return str
        .split(" ")
        .map((x) => x[0].toUpperCase() + x.substr(1))
        .join(" ");
}

/** @param {string} data */
function test(data) {
    data = atob(data);
    let saveStr = data.substring(0, data.length - 42);
    let origHash = data.substring(data.length - 41, data.length - 1);

    let hash = SHA1_hmac(saveStr, "ke03m!5ng93nan7p24lyg343nml2o591");

    if (origHash !== hash) {
        alert("Hash test failed.\nThe save editor is no longer working. Please open an issue on github.");
    }
}

/** @param {string} currentSave */
function processSave(currentSave) {
    console.log(currentSave);

    setupProfileSelect();
    createTables();

    document.getElementById("saveButton").hidden = false;
    document.getElementById("saveRawButton").hidden = false;
}
function resourceTablePrepare(title,id) {
	let profile = currentSave.profiles[currentProfile];

    let resourceTable = document.getElementById(title);
    while (resourceTable.firstChild) {
        resourceTable.removeChild(resourceTable.firstChild);
    }
    resourceTable.appendChild(createRow("", pretty(title), "Amount", "Unlocked"));

    for (const leaf of id) {
        if (!leaf.id) {
            let tr = document.createElement("tr");
            tr.style.lineHeight = "0.75em";
            tr.style.columnSpan = "4";
            tr.innerHTML = "&nbsp;";
            resourceTable.appendChild(tr); // empty row
            continue;
        }

        let item = profile.resources[leaf.id];

        if (!item) {
            profile.resources[leaf.id] = item = {
                collected: 0,
                collected_total: 0,
                count: 0,
                level: 0, // ???
                unlocked: 0,
                unlocked_fruit: 0,
            };
            leaf.name += " (new)";
        }

        let img = document.createElement("img");
        if (leaf.img) {
            img.src = `./img/${leaf.img}`;
			img.width =16;
			img.height =16;
        }

        let label = document.createElement("label");
        label.innerText = leaf.name;

        let amount = document.createElement("input");
        amount.setAttribute("type", "number");
        amount.value = item.count;
        amount.disabled = !item.unlocked;

        amount.addEventListener("change", () => {
            let value = amount.valueAsNumber;

            let change = value - item.count;

            item.count = value;
            item.collected += change;
            item.collected_total += change;
        });

        let unlock = document.createElement("input");
        unlock.type = "checkbox";
        unlock.checked = item.unlocked;
        unlock.addEventListener("input", () => {
            amount.disabled = !unlock.checked;
            item.unlocked = unlock.checked;
        });

        resourceTable.appendChild(createRow(img, label, amount, unlock));
    }
}
function createTables() {
	let profile = currentSave.profiles[currentProfile];
    /*let profile = currentSave.profiles[currentProfile];

    let resourceTable = document.getElementById("resources");
    while (resourceTable.firstChild) {
        resourceTable.removeChild(resourceTable.firstChild);
    }
    resourceTable.appendChild(createRow("", "Resources", "Amount", "Unlocked"));

    for (const leaf of currency) {
        if (!leaf.id) {
            let tr = document.createElement("tr");
            tr.style.lineHeight = "0.75em";
            tr.style.columnSpan = "4";
            tr.innerHTML = "&nbsp;";
            resourceTable.appendChild(tr); // empty row
            continue;
        }

        let item = profile.resources[leaf.id];

        if (!item) {
            profile.resources[leaf.id] = item = {
                collected: 0,
                collected_total: 0,
                count: 0,
                level: 0, // ???
                unlocked: 0,
                unlocked_fruit: 0,
            };
            leaf.name += " (new)";
        }

        let img = document.createElement("img");
        if (leaf.img) {
            img.src = `./img/${leaf.img}`;
        }

        let label = document.createElement("label");
        label.innerText = leaf.name;

        let amount = document.createElement("input");
        amount.setAttribute("type", "number");
        amount.value = item.count;
        amount.disabled = !item.unlocked;

        amount.addEventListener("change", () => {
            let value = amount.valueAsNumber;

            let change = value - item.count;

            item.count = value;
            item.collected += change;
            item.collected_total += change;
        });

        let unlock = document.createElement("input");
        unlock.type = "checkbox";
        unlock.checked = item.unlocked;
        unlock.addEventListener("input", () => {
            amount.disabled = !unlock.checked;
            item.unlocked = unlock.checked;
        });

        resourceTable.appendChild(createRow(img, label, amount, unlock));
    }*/
	resourceTablePrepare("resources",currency)
	resourceTablePrepare("leaves",leaves)
	resourceTablePrepare("borbventures",borbventures)
	resourceTablePrepare("mines",mines)
	resourceTablePrepare("natures",natures)
	resourceTablePrepare("souls",souls)
	resourceTablePrepare("dices",dices)
	resourceTablePrepare("quarks",quarks)
	resourceTablePrepare("fishings",fishings)
    let artifactTable = document.getElementById("artifacts");
    while (artifactTable.firstChild) {
        artifactTable.removeChild(artifactTable.firstChild);
    }
    let elements = [];
    let relative = true;

    {
        let div = document.createElement("div");

        let relCheck = document.createElement("input");
        relCheck.type = "checkbox";
        relCheck.checked = true;
        relCheck.oninput = () => {
            relative = relCheck.checked;
            let t = relative ? "number" : "datetime-local";
            elements.forEach((x) => {
                x.el.type = t;
                x.updateTime();
            });
        };
        div.appendChild(relCheck);

        let label = document.createElement("label");
        label.innerText = "Relative";

        div.append(document.createTextNode("Next spawn"), relCheck, label);
        artifactTable.appendChild(
            createRow("Artifacts", "Shown", "Collected", "Count", div)
        );
    }

    for (const key in profile.artifacts) {
        let item = profile.artifacts[key];

        let timeEl = document.createElement("input");
        elements.push({
            el: timeEl,
            updateTime,
        });
        timeEl.type = "number";

        function updateTime() {
            if (document.activeElement === timeEl) return;
            if (relative) {
                let next = (parseDate(item.spawn_time_raw) - new Date()) / 1000;
                timeEl.value = Math.floor(next);
            } else {
                timeEl.value = dateString(item.spawn_time_raw);
            }
        }
        updateTime();
        setInterval(updateTime, 1000);
        timeEl.addEventListener("change", () => {
            if (relative) {
                let date = new Date();
                date.setTime(date.getTime() + timeEl.valueAsNumber * 1000);
                writeDate(item.spawn_time_raw, date);
            } else {
                let [a, b] = timeEl.value.split("T");
                a = a.split("-").map((x) => parseInt(x));
                b = b.split(":").map((x) => parseInt(x));

                item.spawn_time_raw.year = a[0];
                item.spawn_time_raw.month = a[1];
                item.spawn_time_raw.day = a[2];

                item.spawn_time_raw.hour = b[0];
                item.spawn_time_raw.minute = b[1];
                item.spawn_time_raw.second = b[2];
            }
        });

        function makeIn(name) {
            let el = document.createElement("input");
            el.type = "number";
            el.valueAsNumber = item[name];
            el.style.width = "50px";

            el.addEventListener("change", () => {
                item[name] = el.valueAsNumber;
            });

            return el;
        }

        artifactTable.appendChild(
            createRow(
                pretty(key),
                makeIn("shown"),
                makeIn("collected"),
                makeIn("count"),
                timeEl
            )
        );
    }

    createAmountTable("chests", "Chest Rarity", profile.chests, true);
    createAmountTable("materials", "Material", profile.materials, false);
    createAmountTable("scrolls", "Scroll Type", profile.scrolls, true);
    createAmountTable("equipment", "Equipment", profile.equipment, false);
    createAmountTableSpecial("borbventure", "Borbventure Inventory", profile.borbventure.inventory, false);
	createAmountTableSpecial("mine", "Mine Inventory", profile.mine_inventory, false);
	createAmountTableSpecial("nature_event", "Nature Season Tiers", profile.objects.o_game.data.nature_season, false);
	createAmountTableSpecial("cards", "Cards", profile.cards, false);
    loadCraftedLeaves(profile);
    createAmountTableSpecial("relics", "Relic", profile.relics, true); //too long
	createAmountTableSpecial("enemies", "Enemy Index", profile.enemies, false);
	createAmountTableSpecial("dice", "Dice", profile.dice, false);
	createAmountTableSpecial("dice_backpack", "Dice Backpack", profile.dice_backpack, false);
}

function loadCraftedLeaves(profile) {
    let table = document.getElementById("crafted_leaves");
    while (table.firstChild) {
        table.removeChild(table.firstChild);
    }

    for (const leaf of [...profile.crafted_leaves, ...profile.crafted_backpack]) {
        let name = document.createElement("label");
        name.innerText = pretty(leaf.type_key) + " Leaf";
        name.style.fontWeight = "bold";

        let props = [];
        for (const a_name in leaf.props) {
            const ability = leaf.props[a_name];

            let label = document.createElement("label");
            label.innerText = pretty(a_name);

            let amount = document.createElement("input");
            amount.setAttribute("type", "number");

            const isBig = ability?.startsWith?.("@i64@");
            const isNormalAbility = typeof ability === "number";
            let resource = "";

            if (isBig) {
                amount.setAttribute("type", "text");
                amount.setAttribute("pattern", "-?\\d+");

                amount.value = BigInt("0x" + ability.substring(5, ability.length - 5)).toString();
            } else if (isNormalAbility) {
                amount.setAttribute("step", "any");
                amount.value = ability;
            } else { // leaf-specific ability
                amount.setAttribute("step", "any");
                resource = ability.__resource_key ?? ability.__collection_key;
                amount.value = ability[resource];
                label.innerText += ` (${pretty(resource)} Leaves)`;
            }

            amount.addEventListener("change", () => {
                if (isBig) {
                    try {
                        let v = BigInt(amount.value);
                        leaf.props[a_name] = `@i64@${BigInt.asUintN(64, v).toString(16)}\$i64\$`;
                        amount.value = BigInt.asIntN(64, v);
                    } catch (error) {
                        alert("Invalid number format");
                    }
                } else if (isNormalAbility)
                    leaf.props[a_name] = amount.valueAsNumber;
                else
                    ability[resource] = amount.valueAsNumber;
            });

            props.push({ label, amount });
        }

        table.appendChild(createRow(name, ""));
        for (const ability of props) {
            table.appendChild(createRow(ability.label, ability.amount));
        }

        let tr = document.createElement("tr");
        tr.style.lineHeight = "0.75em";
        tr.style.columnSpan = "2";
        tr.innerHTML = "&nbsp;";
        table.appendChild(tr); // empty row
    }
}

function pretty(str) {
    let res = str.replace(/_/g, " ")
    return capitalize(res)
        .replace(/mlc/gi, "MLC")
        .replace(/blc/gi, "BLC")
        .replace(/hp/gi, "HP");
}

const expected_profiles = [
    {
        key: "def",
        name: "Default Profile",
    },
    {
        key: "challenge",
        name: "Active Challenge",
    },
];

function setupProfileSelect() {
    let select = document.getElementById("profileSelect");
    while (select.firstChild) {
        select.removeChild(select.firstChild);
    }

    for (const key in currentSave.profiles) {
        let option = document.createElement("option");
        option.value = key;
        option.innerText = expected_profiles.find((x) => x.key === key)?.name || key;
        select.appendChild(option);
    }
    select.value = currentProfile = currentSave.current_profile;
    select.addEventListener("change", () => {
        currentProfile = select.value;
        createTables();
    });

    select.hidden = false;

}

function createAmountTable(id, title, data, doUnlocks) {
    let table = document.getElementById(id);
    while (table.firstChild) {
        table.removeChild(table.firstChild);
    }

    if (doUnlocks)
        table.appendChild(createRow(title, "Amount", "Unlocked"));
    else
        table.appendChild(createRow(title, "Amount"));

    for (const key in data) {
        let item = data[key];

        let amount = document.createElement("input");
        amount.setAttribute("type", "number");
        amount.value = item.count;

        if (doUnlocks) amount.disabled = !item.unlocked;

        amount.addEventListener("change", () => {
            let value = amount.valueAsNumber;

            let change = value - item.count;

            item.count = value;
            item.collected += change;
            item.collected_total += change;
        });

        let unlock = document.createElement("input");
        unlock.type = "checkbox";
        unlock.checked = item.unlocked;
        unlock.addEventListener("input", () => {
            amount.disabled = !unlock.checked;
            item.unlocked = unlock.checked;
        });

        if (doUnlocks)
            table.appendChild(createRow(pretty(key), amount, unlock));
        else
            table.appendChild(createRow(pretty(key), amount));
    }
}
/*function tableInitialize(id, title, data, doUnlocks) {
	let table = document.getElementById(id);
		while (table.firstChild) {
			table.removeChild(table.firstChild);
		}

	if (doUnlocks)
		table.appendChild(createRow(title, "Amount", "Unlocked"));
	else
		table.appendChild(createRow(title, "Amount"));
	
	for (const key in data) {
		item = data[key]
		let amount = document.createElement("input");
			amount.setAttribute("type", "number");
			amount.value = item.count;

			if (doUnlocks) amount.disabled = !item.unlocked;

			amount.addEventListener("change", () => {
				let value = amount.valueAsNumber;

				let change = value - item.count;

				item.count = value;
				item.collected += change;
				item.collected_total += change;
			});

			let unlock = document.createElement("input");
			unlock.type = "checkbox";
			unlock.checked = item.unlocked;
			unlock.addEventListener("input", () => {
				amount.disabled = !unlock.checked;
				item.unlocked = unlock.checked;
			});

			if (doUnlocks)
				table.appendChild(pretty(item), amount, unlock));
			else
				table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount));
	}
}*/
function rarityCheck(key, rarity, table, bosses, data) {
	let names = key.split("_")
	let rarity_key = names[0]
	let type_key = ""
	for (i=1; i < names.length; i++) {
		type_key = type_key.concat(names[i], "_")
	}
	if (type_key.at(type_key.length-1) == "_") {
		type_key = type_key.slice(0, type_key.length-1)
	}
	if (key.startsWith(rarity) == true && key.includes("boss") != true) {
		let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key};
		table.push(temptable);
	}
	if (key.includes("boss") == true) {
		let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key};
		//console.log(bosses)
		if (bosses.includes(temptable) == false) {
			//Object.defineProperty(bosses, key, {value:temptable});
		}
	}
	//console.log(bosses)
}
function createAmountTableSpecial(id, title, data, doUnlocks, origin) {
	if (id != "nature_event" && id != "cards" && id != "relics" && id != "enemies") {
		let table = document.getElementById(id);
		while (table.firstChild) {
			table.removeChild(table.firstChild);
		}
		if (id.includes("dice") != true && id.includes("relics") != true) {
			if (doUnlocks)
				table.appendChild(createRow(title, "Amount", "Unlocked"));
			else
				table.appendChild(createRow(title, "Amount")); // Initialize the table
		}
			
		//if (id == "cards_common" || id == "cards_uncommon" || id == "cards_rare" || id == "cards_epic" || id == "cards_mythical" || id == "cards_legendary" || id == "cards_boss") {
			
		//}
		if (id.includes("enemy") == true) { //Checking for enemy tag
			for (const key in data) {
				let item = data[key];
				let card = origin[item]
				
				let amount = document.createElement("input");
				amount.setAttribute("type", "number");
				amount.value = card.defeated;

				if (doUnlocks) amount.disabled = !card.seen;

				amount.addEventListener("change", () => {
					let value = amount.valueAsNumber;

					let change = value - card.defeated;

					card.defeated = value;
					card.defeat_counter += change;
					card.defeat_counter_highest += change;
					card.defeated_run += change;
				});

				let unlock = document.createElement("input");
				unlock.type = "checkbox";
				unlock.checked = card.seen;
				unlock.addEventListener("input", () => {
					amount.disabled = !unlock.checked;
					card.seen = unlock.checked;
				});

				if (doUnlocks) {
					table.appendChild(createRow(pretty(item), amount, unlock));
				} else {
					table.appendChild(createRow(pretty(item), amount));
				}
			}
		return
		}

		if (id.includes("cards") != true && id.includes("relics") != true && id.includes("enemy") != true && id.includes("dice") != true) { //Checking for normal ones
			for (const key in data) {
				let item = data[key];

				let amount = document.createElement("input");
				amount.setAttribute("type", "number");
				amount.value = item.count;
			
				if (doUnlocks) amount.disabled = !item.unlocked;
			
				amount.addEventListener("change", () => {
					let value = amount.valueAsNumber;

					let change = value - item.count;

					item.count = value;
					item.collected += change;
					//item.collected_total += change;
				});

				let unlock = document.createElement("input");
				unlock.type = "checkbox";
				unlock.checked = item.unlocked;
				unlock.addEventListener("input", () => {
					amount.disabled = !unlock.checked;
					item.unlocked = unlock.checked;
				});

				if (doUnlocks) {
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, unlock));
				} else {
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount));
				}
			//return
			}
		return
		}
		if (id == "dice" || id == "dice_backpack") { //Checking for dice
			//if (title.includes("backpack") != true) {
			if (doUnlocks)
				table.appendChild(createRow(title, "Rarity", "Amount", "Unlocked"));
			else
				table.appendChild(createRow(title, "Rarity", "Amount")); // Initialize the table for dice
			//}
			
			for (const key in data) {
				let item = data[key];

				let amount = document.createElement("input");
				amount.setAttribute("type", "number");
				amount.value = item.count;
				
				let rarity = document.createElement("select");
				let rarityTable = ["common","uncommon","rare","epic","mythical","legendary"]
				for (const info in rarityTable) {	
					let rarities = rarityTable[info]
					let option = document.createElement("option")
					option.value = rarities;
					option.innerText = pretty(rarities);
					rarity.appendChild(option)
				}
				rarity.value = item.rarity_key
				
				if (doUnlocks) amount.disabled = !item.unlocked;
			
				amount.addEventListener("change", () => {
					let value = amount.valueAsNumber;

					let change = value - item.count;

					item.count = value;
					//item.collected += change;
					//item.collected_total += change;
				});
				rarity.addEventListener("change", () => {
					let value = rarity.value;
					item.rarity_key = value;
				});

				let unlock = document.createElement("input");
				unlock.type = "checkbox";
				unlock.checked = item.unlocked;
				unlock.addEventListener("input", () => {
					amount.disabled = !unlock.checked;
					item.unlocked = unlock.checked;
				});

				if (doUnlocks) {
					table.appendChild(createRow(pretty(item.type_key), rarity, amount, unlock));
				} else {
					table.appendChild(createRow(pretty(item.type_key), rarity, amount));
				}
			//return
			}
		return
		}

		//if (doUnlocks)
			//table.appendChild(createRow(title, "Amount", "Unlocked"));
		//else
			//table.appendChild(createRow(title, "Amount"));
		if (id.includes("cards") == true) { //Checking for cards tag
			for (const key in data) {
			
				let item = data[key];
				let card = origin[item.id]
				
				let amount = document.createElement("input");
				amount.setAttribute("type", "number");
				amount.value = card.count;

				if (doUnlocks) amount.disabled = !card.unlocked;

				amount.addEventListener("change", () => {
					let value = amount.valueAsNumber;

					let change = value - card.count;

					card.count = value;
					card.collected += change;
					//card.collected_total += change;
				});

				let unlock = document.createElement("input");
				unlock.type = "checkbox";
				unlock.checked = card.unlocked;
				unlock.addEventListener("input", () => {
					amount.disabled = !unlock.checked;
					card.unlocked = unlock.checked;
				});

				if (doUnlocks /*&& id.includes("relics") != true*/) {
				//console.log(item.type_key); // Number of transcended leaves is disabled as unable to find data of it
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, unlock));
				//} else if (doUnlocks && id.includes("relics") == true) {
					//table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, unlock));
				} else {
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount));
				}
			}
		}
		if (id.includes("relics") == true) { //Checking for relic tag
			let profile = currentSave.profiles[currentProfile];
			let leaves = profile.resources
			if (doUnlocks)
				table.appendChild(createRow(title, "Amount", "Leaves", "Unlocked"));
			else
				table.appendChild(createRow(title, "Amount", "Leaves")); // Initialize the table for relics
			for (const key in data) {
			
				let item = data[key];
				let leaf = leaves[item.type]
				let card = origin[item.id]
				let rarityTable = ["common","uncommon","rare","epic","mythical","legendary"]
				let leafIndex = rarityTable.indexOf(item.rarity_key) + 1
				
				let amount = document.createElement("input");
				amount.setAttribute("type", "number");
				amount.value = card.count;
				
				let leafCount = document.createElement("input");
				leafCount.setAttribute("type", "number");
				leafCount.value = leaf.leafscend_count[leafIndex];

				if (doUnlocks) amount.disabled = !card.unlocked;

				amount.addEventListener("change", () => {
					let value = amount.valueAsNumber;

					let change = value - card.count;

					card.count = value;
					card.collected += change;
					//card.collected_total += change;
				});
				
				leafCount.addEventListener("change", () => {
					let value = leafCount.valueAsNumber;

					let change = value - leaf.leafscend_count[leafIndex];

					leaf.leafscend_count[leafIndex] = value;
					leaf.leafscend_collected[leafIndex] += change;
					leaf.leafscend_collected_total[leafIndex] += change;
				});
				
				let unlock = document.createElement("input");
				unlock.type = "checkbox";
				unlock.checked = card.unlocked;
				unlock.addEventListener("input", () => {
					amount.disabled = !unlock.checked;
					card.unlocked = unlock.checked;
				});

				if (doUnlocks /*&& id.includes("relics") != true*/) {
				//console.log(item.type_key);
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, leafCount, unlock));
				//} else if (doUnlocks && id.includes("relics") == true) {
					//table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, unlock));
				} else {
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, leafCount));
				}
			}
		}
		/*if (id.includes("cards") != true && id.includes("relics") != true) {
			for (const key in data) {
				let item = data[key];

				let amount = document.createElement("input");
				amount.setAttribute("type", "number");
				amount.value = item.count;

				if (doUnlocks) amount.disabled = !item.unlocked;

				amount.addEventListener("change", () => {
					let value = amount.valueAsNumber;

					let change = value - item.count;

					item.count = value;
					item.collected += change;
					//item.collected_total += change;
				});

				let unlock = document.createElement("input");
				unlock.type = "checkbox";
				unlock.checked = item.unlocked;
				unlock.addEventListener("input", () => {
					amount.disabled = !unlock.checked;
					item.unlocked = unlock.checked;
				});

				if (doUnlocks) {
					//console.log(item.type_key);
					//console.log(pretty("test_"));
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, unlock));
				} else {
					table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount));
				}
			//return
			}
		return
		}*/
		
	}
	if (id == "cards" || id == "relics") {
		let common = [];
		let uncommon = [];
		let rare = [];
		let epic = [];
		let mythical = [];
		let legendary = [];
		let bosses = [];
		for (const key in data) {
			let names = key.split("_")
			let rarity_key = names[0]
			let type_key = ""
			let type = ""
			for (i=1; i < names.length; i++) {
				type_key = type_key.concat(names[i], "_")
			}
			if (type_key.at(type_key.length-1) == "_") {
				type_key = type_key.slice(0, type_key.length-1)
			}
			if (id == "relics") {
				type = type_key
				type_key = type_key.concat("_","leaves")
			}
			if (key.startsWith("common") == true && key.includes("boss") != true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key, type:type};
				common.push(temptable);
			}
			if (key.startsWith("uncommon") == true && key.includes("boss") != true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key, type:type};
				uncommon.push(temptable);
			}
			if (key.startsWith("rare") == true && key.includes("boss") != true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key, type:type};
				rare.push(temptable);
			}
			if (key.startsWith("epic") == true && key.includes("boss") != true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key, type:type};
				epic.push(temptable);
			}
			if (key.startsWith("mythical") == true && key.includes("boss") != true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key, type:type};
				mythical.push(temptable);
			}
			if (key.startsWith("legendary") == true && key.includes("boss") != true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key, type:type};
				legendary.push(temptable);
			}
			if (key.includes("boss") == true) {
				let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key};
		//console.log(bosses)
				//if (bosses.includes(temptable) == false) {
			//Object.defineProperty(bosses, key, {value:temptable});
				//}
				bosses.push(temptable)
			}
			//item = data[key];
			//let name = key
			//console.log(key)
			//rarityCheck(key, "common", common, bosses, data);
			//rarityCheck(key, "uncommon", uncommon, bosses, data);
			//rarityCheck(key, "rare", rare, bosses, data);
			//rarityCheck(key, "epic", epic, bosses, data);
			//rarityCheck(key, "mythical", mythical, bosses, data);
			//rarityCheck(key, "legendary", legendary, bosses, data);
		}
		//console.log(legendary)
		if (id == "cards") {
			createAmountTableSpecial("cards_common", "Common Cards", common, true, data)
			createAmountTableSpecial("cards_uncommon", "Uncommon Cards", uncommon, true, data)
			createAmountTableSpecial("cards_rare", "Rare Cards", rare, true, data)
			createAmountTableSpecial("cards_epic", "Epic Cards", epic, true, data)
			createAmountTableSpecial("cards_mythical", "Mythical Cards", mythical, true, data)
			createAmountTableSpecial("cards_legendary", "Legendary Cards", legendary, true, data)
			createAmountTableSpecial("cards_boss", "Boss Cards", bosses, true, data)
		}
		if (id == "relics") {
			createAmountTableSpecial("relics_common", "Common Relics", common, true, data)
			createAmountTableSpecial("relics_uncommon", "Uncommon Relics", uncommon, true, data)
			createAmountTableSpecial("relics_rare", "Rare Relics", rare, true, data)
			createAmountTableSpecial("relics_epic", "Epic Relics", epic, true, data)
			createAmountTableSpecial("relics_mythical", "Mythical Relics", mythical, true, data)
			createAmountTableSpecial("relics_legendary", "Legendary Relics", legendary, true, data)
		}
		//return
		/*let commontable = document.getElementById("cards_common");
		while (table.firstChild) {
			table.removeChild(table.firstChild);
		}

		if (doUnlocks)
			table.appendChild(createRow(title, "Amount", "Unlocked"));
		else
			table.appendChild(createRow(title, "Amount"));

		for (const key in data) {
			let item = data[key];

			let amount = document.createElement("input");
			amount.setAttribute("type", "number");
			amount.value = item.count;

			if (doUnlocks) amount.disabled = !item.unlocked;

			amount.addEventListener("change", () => {
				let value = amount.valueAsNumber;

				let change = value - item.count;

				item.count = value;
				item.collected += change;
				item.collected_total += change;
			});

			let unlock = document.createElement("input");
			unlock.type = "checkbox";
			unlock.checked = item.unlocked;
			unlock.addEventListener("input", () => {
				amount.disabled = !unlock.checked;
				item.unlocked = unlock.checked;
			});

			if (doUnlocks)
				table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount, unlock));
			else
				table.appendChild(createRow(pretty(item.type_key)+"("+pretty(item.rarity_key)+")", amount));
		}
		return */
		return
	}
	if (id == "enemies") {
		let enemy = [];
		let boss = [];
		for (const key in data) {
			if (key.startsWith("boss") == true) {
				//let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key};
				boss.push(key);
			} else {
				//let temptable = {id:key, count:data[key].count, collected:data[key].collected, unlocked:data[key].unlocked, type_key:type_key, rarity_key:rarity_key};
				enemy.push(key);
			}
		}
		//console.log(boss)
		createAmountTableSpecial("enemy_normal", "Normal Enemies", enemy, true, data)
		createAmountTableSpecial("enemy_boss", "Boss Enemies", boss, true, data)
		
	return
	}
	if (data == "nature_event") {
	let table = document.getElementById(id);
		while (table.firstChild) {
			table.removeChild(table.firstChild);
		}

		if (doUnlocks)
			table.appendChild(createRow(title, "Amount", "Unlocked"));
		else
			table.appendChild(createRow(title, "Amount"));

		let item = data["level"];
		let currentXP = data["xp"];
		let totalXP = data["xp_total"];

		let amount = document.createElement("input");
		amount.setAttribute("type", "number");
		amount.value = item;

		//if (doUnlocks) amount.disabled = !item.unlocked;

		amount.addEventListener("change", () => {
			let value = amount.valueAsNumber;
			let tempXP = 0;
			let finalXP = 0;
			let change = value - data.level;

			data.level = value;
			for (i = 0; i < value; i++) {
				let xpRequired = 3 + i**2;
				finalXP += xpRequired
			}

			if (value >= 100 && tempXP == 0) {
				tempXP = currentXP;
				data.xp = 0;
				data.xp_total = finalXP;
			} else {
				data.xp += tempXP;
				data.xp_total = finalXP + currentXP;
			}
			
		});

		let unlock = document.createElement("input");
		unlock.type = "checkbox";
		unlock.checked = item.unlocked;
		unlock.addEventListener("input", () => {
			amount.disabled = !unlock.checked;
			item.unlocked = unlock.checked;
		});

		if (doUnlocks)
			table.appendChild(createRow("Tier(Min 0 ; Max 100)", amount, unlock));
		else
			table.appendChild(createRow("Tier(Min 0 ; Max 100)", amount));
	}
}

function loadDat(data) {
    test(data);

    data = atob(data);

    currentSave = JSON.parse(data.substring(0, data.length - 42));

    processSave(currentSave);
}

function loadJson(data) {
    currentSave = JSON.parse(data);

    processSave(currentSave);
}

/**
 * @param {string} filename
 * @param {string} data
 */
function download(filename, data) {
    var file = new Blob([data], {
        type: "text/plain",
    });
    if (window.navigator.msSaveOrOpenBlob) {
        // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    } else {
        // Others
        let a = document.createElement("a");
        let url = URL.createObjectURL(file);

        a.href = url;
        a.download = filename;
        a.style.display = "none";

        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 0);
    }
}

function save() {
    writeDate(currentSave.time, new Date());

    let dataString = JSON.stringify(currentSave);
    let hash = SHA1_hmac(dataString, "ke03m!5ng93nan7p24lyg343nml2o591");

    dataString += `#${hash}#`;
    dataString = btoa(dataString);

    download("save.dat", dataString);
}

function saveRaw() {
    download("save.json", JSON.stringify(currentSave, null, 4));
}
